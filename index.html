import React, { useState, useEffect } from 'react';
import { Download, Sparkles, Zap, ChevronDown, ChevronUp } from 'lucide-react';

export default function WinionsMemeGenerator() {
  const [topText, setTopText] = useState('');
  const [bottomText, setBottomText] = useState('');
  const [generatedImage, setGeneratedImage] = useState(null);
  const [isGenerating, setIsGenerating] = useState(false);
  const [apiKey, setApiKey] = useState('');
  const [showSettings, setShowSettings] = useState(false);
  const [showTemplates, setShowTemplates] = useState(false);
  const [selectedStyle, setSelectedStyle] = useState('classic');

  // Spooky meme templates
  const templates = [
    { top: 'WHEN THE BLOCKCHAIN', bottom: 'CALLS YOUR NAME' },
    { top: 'POV: YOU FOUND', bottom: 'THE HIDDEN WINION' },
    { top: 'NOBODY:', bottom: 'WINIONS AT 3AM:' },
    { top: 'THAT MOMENT WHEN', bottom: 'GAS FEES ARE LOW' },
    { top: 'WINIONS BE LIKE', bottom: 'SPOOKY SZN 24/7' },
    { top: 'ME EXPLAINING', bottom: 'WHY I NEED MORE WINIONS' },
    { top: 'THEY DON\'T KNOW', bottom: 'I\'M A WINION' },
    { top: 'WAKE UP BABE', bottom: 'NEW WINION DROPPED' },
    { top: 'MOM CAN WE GET', bottom: 'WINIONS AT HOME' },
    { top: 'THE VIBES', bottom: 'ARE IMMACULATE' },
    { top: 'POV: IT\'S 3AM', bottom: 'AND I HEAR VOICES' },
    { top: 'BREAKING:', bottom: 'WINION SPOTTED' },
    { top: 'SUFFERING FROM SUCCESS', bottom: 'BEING A WINION' },
    { top: 'THIS IS FINE', bottom: 'EVERYTHING IS FINE' },
    { top: 'ENTERING THE', bottom: 'WINION METAVERSE' }
  ];

  // Generate random text on mount
  useEffect(() => {
    randomizeText();
  }, []);

  const randomizeText = () => {
    const randomTemplate = templates[Math.floor(Math.random() * templates.length)];
    setTopText(randomTemplate.top);
    setBottomText(randomTemplate.bottom);
  };

  // Style presets for image generation (hidden from user)
  const stylePrompts = {
    classic: 'simple geometric cone-shaped character with round head, dark glowing eyes, small buttons on chest, heavy CRT scanlines, VHS glitch effect, chromatic aberration, RGB color shift, digital corruption, analog horror aesthetic, vibrant neon colors bleeding, retro video game sprite style, distorted colors, static noise background',
    neon: 'simple geometric cone-shaped character with round head, dark eyes, buttons on body, intense neon green and pink glow, extreme CRT scanlines, heavy chromatic aberration, VHS tape corruption, glitch art, RGB separation, electric colors, digital artifacts, phosphor glow effect',
    corrupted: 'simple geometric cone-shaped character with round head, glowing dots for eyes, chest buttons, extreme VHS corruption, heavy TV static, chromatic aberration, glitch art, color bleeding, scanline distortion, analog video noise, RGB shift, degraded video tape aesthetic, pixel sorting',
    ethereal: 'simple geometric cone-shaped character with round head, minimal features, soft glowing aura, golden yellow light, CRT scanlines, chromatic aberration, VHS glow effect, light leaks, color fringing, angelic energy, digital haze, phosphor trails'
  };

  const generateWithTogetherAI = async () => {
    if (!apiKey) {
      alert('Please add your Together.ai API key in settings!');
      return;
    }

    setIsGenerating(true);
    try {
      const fullPrompt = `${stylePrompts[selectedStyle]}, cute character art, meme style, high quality digital art`;
      
      const response = await fetch('https://api.together.xyz/v1/images/generations', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${apiKey}`,
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          model: 'black-forest-labs/FLUX.1-schnell-Free',
          prompt: fullPrompt,
          width: 512,
          height: 512,
          steps: 4,
          n: 1
        })
      });

      const data = await response.json();
      if (data.data && data.data[0]?.url) {
        setGeneratedImage(data.data[0].url);
      } else {
        console.error('Unexpected response:', data);
        alert('Failed to generate image. Check console for details.');
      }
    } catch (error) {
      console.error('Error:', error);
      alert('Error generating image: ' + error.message);
    } finally {
      setIsGenerating(false);
    }
  };

  const downloadMeme = () => {
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    canvas.width = 600;
    canvas.height = 700;

    // Black background
    ctx.fillStyle = '#000000';
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    // Add generated image if available
    if (generatedImage) {
      const img = new Image();
      img.crossOrigin = 'anonymous';
      img.src = generatedImage;
      img.onload = () => {
        ctx.drawImage(img, 50, 100, 500, 500);
        addText();
        triggerDownload();
      };
    } else {
      // Placeholder dark gradient
      const gradient = ctx.createLinearGradient(0, 0, 600, 700);
      gradient.addColorStop(0, '#1a1a1a');
      gradient.addColorStop(1, '#000000');
      ctx.fillStyle = gradient;
      ctx.fillRect(50, 100, 500, 500);
      addText();
      triggerDownload();
    }

    function addText() {
      // Top text
      ctx.font = 'bold 56px Impact, sans-serif';
      ctx.fillStyle = 'white';
      ctx.strokeStyle = 'black';
      ctx.lineWidth = 5;
      ctx.textAlign = 'center';
      ctx.strokeText(topText.toUpperCase(), canvas.width / 2, 70);
      ctx.fillText(topText.toUpperCase(), canvas.width / 2, 70);

      // Bottom text
      ctx.strokeText(bottomText.toUpperCase(), canvas.width / 2, 650);
      ctx.fillText(bottomText.toUpperCase(), canvas.width / 2, 650);

      // Winions watermark in red
      ctx.font = 'bold 16px Arial';
      ctx.fillStyle = '#ef4444';
      ctx.fillText('WINIONS.XYZ', canvas.width / 2, 690);
    }

    function triggerDownload() {
      canvas.toBlob((blob) => {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'winions-meme.png';
        a.click();
        URL.revokeObjectURL(url);
      });
    }
  };

  return (
    <div className="min-h-screen bg-black text-white p-4 sm:p-6 lg:p-8">
      <div className="max-w-7xl mx-auto">
        {/* Header */}
        <div className="text-center mb-6 sm:mb-8 lg:mb-12">
          <h1 className="text-3xl sm:text-4xl lg:text-5xl font-black mb-2 sm:mb-4 text-red-500 tracking-wider">
            MEME GENERATOR
          </h1>
          <p className="text-sm sm:text-base text-gray-400">Create and share your Winions memes</p>
        </div>

        <div className="grid lg:grid-cols-2 gap-4 sm:gap-6 lg:gap-8">
          {/* Preview Panel */}
          <div className="space-y-3 sm:space-y-4">
            <div className="border border-gray-800 rounded-lg p-4 sm:p-6">
              <h2 className="text-lg sm:text-xl font-bold mb-3 sm:mb-4 text-red-500">PREVIEW</h2>
              
              {/* Meme Preview */}
              <div className="relative bg-gray-900 rounded-lg overflow-hidden aspect-square border border-gray-800">
                {generatedImage ? (
                  <img src={generatedImage} alt="Generated Winion" className="w-full h-full object-cover" />
                ) : (
                  <div className="w-full h-full bg-gradient-to-br from-gray-900 to-black flex items-center justify-center">
                    <div className="text-center p-4 sm:p-8">
                      <Sparkles className="w-12 h-12 sm:w-16 sm:h-16 mx-auto mb-3 sm:mb-4 text-red-500" />
                      <p className="text-sm sm:text-base text-gray-400">Generate a Winion</p>
                    </div>
                  </div>
                )}
                
                {/* Top Text Overlay */}
                <div className="absolute top-2 sm:top-4 left-0 right-0 text-center px-2 sm:px-4">
                  <h3 className="text-2xl sm:text-4xl lg:text-5xl font-black text-white leading-tight" style={{
                    textShadow: '3px 3px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 3px 3px 8px rgba(0,0,0,0.8)',
                    fontFamily: 'Impact, Arial Black, sans-serif'
                  }}>
                    {topText.toUpperCase()}
                  </h3>
                </div>
                
                {/* Bottom Text Overlay */}
                <div className="absolute bottom-2 sm:bottom-4 left-0 right-0 text-center px-2 sm:px-4">
                  <h3 className="text-2xl sm:text-4xl lg:text-5xl font-black text-white leading-tight" style={{
                    textShadow: '3px 3px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 3px 3px 8px rgba(0,0,0,0.8)',
                    fontFamily: 'Impact, Arial Black, sans-serif'
                  }}>
                    {bottomText.toUpperCase()}
                  </h3>
                </div>

                {/* Watermark */}
                <div className="absolute bottom-1 right-2 sm:bottom-2 sm:right-4">
                  <p className="text-xs sm:text-sm font-bold text-red-500">WINIONS.XYZ</p>
                </div>
              </div>

              {/* Download Button */}
              <button
                onClick={downloadMeme}
                className="w-full mt-3 sm:mt-4 bg-red-600 hover:bg-red-700 text-white font-bold py-2.5 sm:py-3 px-4 sm:px-6 rounded-lg transition-all flex items-center justify-center gap-2 text-sm sm:text-base"
              >
                <Download className="w-4 h-4 sm:w-5 sm:h-5" />
                DOWNLOAD MEME
              </button>
            </div>
          </div>

          {/* Controls Panel */}
          <div className="space-y-3 sm:space-y-4">
            {/* Settings Toggle */}
            <button
              onClick={() => setShowSettings(!showSettings)}
              className="w-full bg-gray-900 hover:bg-gray-800 border border-gray-800 text-gray-400 font-semibold py-2 px-4 rounded-lg transition-all text-sm sm:text-base"
            >
              {showSettings ? '✕ Close Settings' : '⚙ API Settings'}
            </button>

            {showSettings && (
              <div className="border border-gray-800 rounded-lg p-4 sm:p-6 bg-gray-900">
                <label className="block text-sm font-semibold text-red-500 mb-2">
                  Together.ai API Key
                </label>
                <input
                  type="password"
                  value={apiKey}
                  onChange={(e) => setApiKey(e.target.value)}
                  placeholder="Enter your API key"
                  className="w-full bg-black border border-gray-800 rounded-lg px-3 sm:px-4 py-2 text-sm sm:text-base text-white placeholder-gray-600 focus:outline-none focus:border-red-500"
                />
                <p className="text-xs text-gray-500 mt-2">
                  Get your key at <a href="https://together.ai" target="_blank" rel="noopener noreferrer" className="text-red-500 hover:underline">together.ai</a>
                </p>
              </div>
            )}

            {/* Image Generation */}
            <div className="border border-gray-800 rounded-lg p-4 sm:p-6 bg-gray-900">
              <h3 className="text-lg sm:text-xl font-bold mb-3 sm:mb-4 text-red-500">GENERATE WINION</h3>
              
              <label className="block text-xs sm:text-sm font-semibold text-gray-400 mb-2">
                Winion Style
              </label>
              <div className="grid grid-cols-2 gap-2 mb-3 sm:mb-4">
                {Object.keys(stylePrompts).map((style) => (
                  <button
                    key={style}
                    onClick={() => setSelectedStyle(style)}
                    className={`py-2 px-3 sm:px-4 rounded-lg font-semibold transition-all text-xs sm:text-sm ${
                      selectedStyle === style
                        ? 'bg-red-600 text-white'
                        : 'bg-black border border-gray-800 text-gray-400 hover:border-gray-700'
                    }`}
                  >
                    {style.toUpperCase()}
                  </button>
                ))}
              </div>

              <button
                onClick={generateWithTogetherAI}
                disabled={isGenerating}
                className="w-full bg-red-600 hover:bg-red-700 disabled:bg-gray-700 disabled:cursor-not-allowed text-white font-bold py-2.5 sm:py-3 px-4 sm:px-6 rounded-lg transition-all flex items-center justify-center gap-2 text-sm sm:text-base"
              >
                {isGenerating ? (
                  <>
                    <div className="w-4 h-4 sm:w-5 sm:h-5 border-2 border-white border-t-transparent rounded-full animate-spin" />
                    Generating...
                  </>
                ) : (
                  <>
                    <Zap className="w-4 h-4 sm:w-5 sm:h-5" />
                    GENERATE IMAGE
                  </>
                )}
              </button>
            </div>

            {/* Text Customization */}
            <div className="border border-gray-800 rounded-lg p-4 sm:p-6 bg-gray-900">
              <div className="flex items-center justify-between mb-3 sm:mb-4">
                <h3 className="text-lg sm:text-xl font-bold text-red-500">MEME TEXT</h3>
                <button
                  onClick={randomizeText}
                  className="text-xs sm:text-sm bg-black border border-gray-800 hover:border-red-500 text-gray-400 hover:text-white px-2 sm:px-3 py-1 rounded transition-all"
                >
                  🎲 Random
                </button>
              </div>
              
              <div className="space-y-3 sm:space-y-4">
                <div>
                  <label className="block text-xs sm:text-sm font-semibold text-gray-400 mb-2">
                    Top Text
                  </label>
                  <input
                    type="text"
                    value={topText}
                    onChange={(e) => setTopText(e.target.value)}
                    className="w-full bg-black border border-gray-800 rounded-lg px-3 sm:px-4 py-2 text-sm sm:text-base text-white placeholder-gray-600 focus:outline-none focus:border-red-500"
                    placeholder="Top text..."
                  />
                </div>

                <div>
                  <label className="block text-xs sm:text-sm font-semibold text-gray-400 mb-2">
                    Bottom Text
                  </label>
                  <input
                    type="text"
                    value={bottomText}
                    onChange={(e) => setBottomText(e.target.value)}
                    className="w-full bg-black border border-gray-800 rounded-lg px-3 sm:px-4 py-2 text-sm sm:text-base text-white placeholder-gray-600 focus:outline-none focus:border-red-500"
                    placeholder="Bottom text..."
                  />
                </div>
              </div>

              {/* Templates Accordion */}
              <div className="mt-4 sm:mt-6">
                <button
                  onClick={() => setShowTemplates(!showTemplates)}
                  className="w-full flex items-center justify-between bg-black border border-gray-800 hover:border-gray-700 rounded-lg px-3 sm:px-4 py-2 sm:py-2.5 text-xs sm:text-sm font-semibold text-gray-400 hover:text-white transition-all"
                >
                  <span>QUICK TEMPLATES</span>
                  {showTemplates ? (
                    <ChevronUp className="w-4 h-4" />
                  ) : (
                    <ChevronDown className="w-4 h-4" />
                  )}
                </button>

                {showTemplates && (
                  <div className="mt-2 space-y-2 max-h-64 overflow-y-auto">
                    {templates.map((template, idx) => (
                      <button
                        key={idx}
                        onClick={() => {
                          setTopText(template.top);
                          setBottomText(template.bottom);
                        }}
                        className="w-full bg-black border border-gray-800 hover:border-red-500 rounded-lg px-3 py-2 text-xs sm:text-sm font-semibold text-left transition-all text-gray-400 hover:text-white"
                      >
                        <div className="text-[10px] sm:text-xs text-gray-600">TOP:</div>
                        <div className="truncate">{template.top}</div>
                        <div className="text-[10px] sm:text-xs text-gray-600 mt-1">BOTTOM:</div>
                        <div className="truncate">{template.bottom}</div>
                      </button>
                    ))}
                  </div>
                )}
              </div>
            </div>

            {/* Social Call to Action */}
            <div className="border border-red-900 rounded-lg p-4 sm:p-6 bg-gradient-to-br from-red-950/20 to-black text-center">
              <h3 className="text-lg sm:text-xl font-bold mb-2 text-red-500">SHARE YOUR CREATION</h3>
              <p className="text-xs sm:text-sm text-gray-400 mb-3">
                Spread the chaos across the metaverse
              </p>
              <a 
                href="https://winions.xyz" 
                target="_blank" 
                rel="noopener noreferrer"
                className="inline-block bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 sm:px-6 rounded-lg transition-all text-sm sm:text-base"
              >
                WINIONS.XYZ
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}
